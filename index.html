<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monthly Expense Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, sans-serif;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      /* Mobile-friendly table scroll hint */
      .table-container {
        position: relative;
      }
      .table-container::after {
        content: '‚Üê Scroll horizontally ‚Üí';
        display: block;
        text-align: center;
        padding: 8px;
        background: #eef2ff;
        color: #4f46e5;
        font-size: 0.875rem;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
      }
      @media (min-width: 768px) {
        .table-container::after {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;

      const firebaseConfig = {
        apiKey: "AIzaSyAoofQz9iOxLDl9Xa_f_UbzZCkshNCjUW4",
        authDomain: "expense-report-826a7.firebaseapp.com",
        projectId: "expense-report-826a7",
        storageBucket: "expense-report-826a7.firebasestorage.app",
        messagingSenderId: "238599367354",
        appId: "1:238599367354:web:dd12a7dc2c6e70aea0f083",
        measurementId: "G-QW3LYEC24T",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const FIXED_USER_ID = "rakesh-expense-tracker";

      // SVG Icons (unchanged)
      const Plus = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      );

      const Trash2 = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      );

      const TrendingUp = () => (
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
          <polyline points="17 6 23 6 23 12" />
        </svg>
      );

      const TrendingDown = () => (
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />
          <polyline points="17 18 23 18 23 12" />
        </svg>
      );

      const Calendar = () => (
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      );

      const Cloud = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />
        </svg>
      );

      const MonthlyExpenseSheet = () => {
        const [month, setMonth] = useState("December");
        const [year, setYear] = useState("2025");
        const [startingBalance, setStartingBalance] = useState(50000);
        const [syncStatus, setSyncStatus] = useState("synced");
        const [expenses, setExpenses] = useState([]);
        const isInitialLoad = useRef(true);

        const monthIndex = ["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(month);
        const monthKey = `${year}-${String(monthIndex + 1).padStart(2, "0")}`;

        const expenseOptions = [
          "Ravi Fast Food","E Trade","Fuel","Udayavani Canteen","Hotel Manohar Bhavan",
          "Manipal Lunch Home","Vinayak Store","Darsh Fast Food","Anand Bhavan",
          "Medical Store","Other (Custom)"
        ];

        const mealOptions = ["", "Lunch", "Tea"];

        const syncToCloud = useCallback(async (data) => {
          if (isInitialLoad.current) return;
          try {
            setSyncStatus("syncing");
            await db.collection("expenseTracker").doc(FIXED_USER_ID).collection("months").doc(monthKey).set(data);
            setSyncStatus("synced");
          } catch (error) {
            console.error("Firebase sync error:", error);
            setSyncStatus("error");
          }
        }, [monthKey]);

        const loadFromCloud = useCallback(async () => {
          try {
            const doc = await db.collection("expenseTracker").doc(FIXED_USER_ID).collection("months").doc(monthKey).get();
            if (doc.exists) {
              const data = doc.data();
              setStartingBalance(data.startingBalance ?? 50000);
              setExpenses(data.expenses ?? []);
            } else {
              setExpenses([]);
            }
          } catch (error) {
            console.error("Firebase load error:", error);
          }
        }, [monthKey]);

        useEffect(() => {
          loadFromCloud();
        }, [loadFromCloud]);

        useEffect(() => {
          if (isInitialLoad.current) {
            isInitialLoad.current = false;
            return;
          }

          const dataToSync = { month, year, startingBalance, expenses, lastUpdated: new Date().toISOString() };
          const timer = setTimeout(() => syncToCloud(dataToSync), 800);
          return () => clearTimeout(timer);
        }, [month, year, startingBalance, expenses, syncToCloud]);

        const exportToExcel = () => {
          const wsData = [["Date", "Description", "Meal", "Debit", "Credit"], ...expenses.map(e => [e.date, e.description, e.meal, e.debit, e.credit])];
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Expenses");
          XLSX.writeFile(wb, `Expense_${month}_${year}.xlsx`);
        };

        const importFromExcel = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, { type: "array" });
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
            const maxId = expenses.length ? Math.max(...expenses.map(ex => ex.id)) : 0;
            const newExpenses = rows.slice(1).map((row, i) => ({
              id: maxId + i + 1,
              date: row[0] || "",
              description: row[1] || "",
              meal: row[2] || "",
              debit: row[3] || "",
              credit: row[4] || "",
              isCustom: true,
            }));
            setExpenses(newExpenses);
          };
          reader.readAsArrayBuffer(file);
        };

        const addExpense = () => {
          const newId = expenses.length ? Math.max(...expenses.map(e => e.id)) + 1 : 1;
          setExpenses(prev => [...prev, {
            id: newId,
            date: new Date().toISOString().split("T")[0],
            description: "",
            debit: "",
            credit: "",
            meal: "",
            isCustom: false,
          }]);
        };

        const deleteExpense = useCallback((id) => {
          setExpenses(prev => prev.filter(e => e.id !== id));
        }, []);

        const updateExpense = useCallback((id, field, value) => {
          setExpenses(prev => prev.map(e => {
            if (e.id !== id) return e;
            if (field === "debit") return { ...e, debit: value, credit: "" };
            if (field === "credit") return { ...e, credit: value, debit: "" };
            return { ...e, [field]: value };
          }));
        }, []);

        const calculations = useMemo(() => {
          const openingBalance = Number(startingBalance) || 0;
          const totalDebit = expenses.reduce((s, e) => s + (Number(e.debit) || 0), 0);
          const totalCredit = expenses.reduce((s, e) => s + (Number(e.credit) || 0), 0);
          const netDebit = totalDebit - totalCredit;
          const currentBalance = openingBalance + totalCredit - totalDebit;

          const lunchTotal = expenses.filter(e => e.meal === "Lunch").reduce((s, e) => s + (Number(e.debit) || 0), 0);
          const teaTotal = expenses.filter(e => e.meal === "Tea").reduce((s, e) => s + (Number(e.debit) || 0), 0);

          const expenseByDescription = {};
          expenses.forEach(e => {
            if (!["Lunch", "Tea"].includes(e.meal)) {
              const key = e.description || "Other";
              expenseByDescription[key] = (expenseByDescription[key] || 0) + (Number(e.debit) || 0);
            }
          });

          return { openingBalance, totalDebit, totalCredit, netDebit, currentBalance, lunchTotal, teaTotal, expenseByDescription };
        }, [expenses, startingBalance]);

        const getSyncStatusColor = () => {
          return syncStatus === "syncing" ? "text-yellow-600" :
                 syncStatus === "synced" ? "text-green-600" :
                 syncStatus === "error" ? "text-red-600" : "text-gray-600";
        };

        const getSyncStatusText = () => {
          return syncStatus === "syncing" ? "Syncing..." :
                 syncStatus === "synced" ? "All changes saved" :
                 syncStatus === "error" ? "Sync error" : "Ready";
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6">
                <div className="flex flex-col gap-4 mb-6">
                  <div className="flex items-start justify-between">
                    <div className="flex items-center gap-3">
                      <Calendar />
                      <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Monthly Expense Tracker</h1>
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center gap-3">
                    <div className={`flex items-center gap-2 ${getSyncStatusColor()}`}>
                      <Cloud />
                      <span className="text-sm font-medium">{getSyncStatusText()}</span>
                    </div>

                    <button onClick={addExpense} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition text-sm font-medium min-w-[120px] justify-center">
                      <Plus /> Add Row
                    </button>

                    <button onClick={exportToExcel} className="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition text-sm font-medium min-w-[120px]">
                      Export Excel
                    </button>

                    <label className="bg-blue-600 text-white px-4 py-3 rounded-lg cursor-pointer hover:bg-blue-700 transition text-sm font-medium min-w-[120px] text-center">
                      Import Excel
                      <input type="file" accept=".xlsx,.xls" onChange={importFromExcel} className="hidden" />
                    </label>
                  </div>
                </div>

                {/* Controls */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Month</label>
                    <select value={month} onChange={e => setMonth(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-base">
                      {["January","February","March","April","May","June","July","August","September","October","November","December"].map(m => (
                        <option key={m} value={m}>{m}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Year</label>
                    <input type="number" value={year} onChange={e => setYear(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-base" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Starting Balance (‚Çπ)</label>
                    <input type="number" value={startingBalance} onChange={e => setStartingBalance(Number(e.target.value) || 0)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-base" />
                  </div>
                </div>

                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-800"><strong>üì± User ID:</strong> {FIXED_USER_ID}</p>
                  <p className="text-xs text-blue-600 mt-1">Data is automatically synced to Firebase</p>
                </div>
              </div>

              {/* Expenses Table */}
              <div className="bg-white rounded-lg shadow-lg overflow-hidden mb-6 table-container">
                <div className="overflow-x-auto -mx-4 sm:mx-0">
                  {calculations.currentBalance < 0 && (
                    <div className="bg-red-100 text-red-800 px-4 py-3 mx-4 mt-4 rounded-lg text-sm">
                      ‚ö†Ô∏è Warning: Your expenses exceed your available balance!
                    </div>
                  )}
                  <table className="w-full min-w-[900px]">
                    <thead className="bg-indigo-600 text-white">
                      <tr>
                        <th className="px-3 py-4 text-left font-semibold text-sm">Date</th>
                        <th className="px-3 py-4 text-left font-semibold text-sm">Description</th>
                        <th className="px-3 py-4 text-left font-semibold text-sm">Meal</th>
                        <th className="px-3 py-4 text-left font-semibold text-sm">Debit (‚Çπ)</th>
                        <th className="px-3 py-4 text-left font-semibold text-sm">Credit (‚Çπ)</th>
                        <th className="px-3 py-4 text-center font-semibold text-sm">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {expenses.map((expense, i) => (
                        <tr key={expense.id} className={i % 2 === 0 ? "bg-gray-50" : "bg-white"}>
                          <td className="px-3 py-3">
                            <input type="date" value={expense.date} onChange={e => updateExpense(expense.id, "date", e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm" />
                          </td>
                          <td className="px-3 py-3">
                            {expense.isCustom ? (
                              <div className="flex flex-col sm:flex-row gap-2">
                                <input type="text" value={expense.description} onChange={e => updateExpense(expense.id, "description", e.target.value)} placeholder="Custom description" className="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm" />
                                <button onClick={() => setExpenses(prev => prev.map(ex => ex.id === expense.id ? { ...ex, isCustom: false, description: "" } : ex))} className="px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded">‚Ü©</button>
                              </div>
                            ) : (
                              <select value={expense.description} onChange={e => {
                                const val = e.target.value;
                                if (val === "Other (Custom)") {
                                  setExpenses(prev => prev.map(ex => ex.id === expense.id ? { ...ex, isCustom: true, description: "" } : ex));
                                } else {
                                  updateExpense(expense.id, "description", val);
                                }
                              }} className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="">Select...</option>
                                {expenseOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                              </select>
                            )}
                          </td>
                          <td className="px-3 py-3">
                            <select value={expense.meal} onChange={e => updateExpense(expense.id, "meal", e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm">
                              {mealOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                          </td>
                          <td className="px-3 py-3">
                            <input type="number" min="0" value={expense.debit} onChange={e => updateExpense(expense.id, "debit", e.target.value)} placeholder="0" className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm" />
                          </td>
                          <td className="px-3 py-3">
                            <input type="number" min="0" value={expense.credit} onChange={e => updateExpense(expense.id, "credit", e.target.value)} placeholder="0" className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm" />
                          </td>
                          <td className="px-3 py-3 text-center">
                            <button onClick={() => deleteExpense(expense.id)} className="text-red-600 hover:text-red-800 p-2">
                              <Trash2 />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Summary Cards - Stack on mobile */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {/* Cards remain the same visually, just better stacking */}
                <div className="bg-white rounded-lg shadow-lg p-5">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 mb-1">Opening Balance</p>
                      <p className="text-2xl font-bold text-blue-600">‚Çπ{calculations.openingBalance.toLocaleString()}</p>
                    </div>
                    <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center"><span className="text-2xl">üíº</span></div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-5">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 mb-1">Other Credits</p>
                      <p className="text-2xl font-bold text-green-600">‚Çπ{calculations.totalCredit.toLocaleString()}</p>
                    </div>
                    <TrendingUp />
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-5">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 mb-1">Net Debit</p>
                      <p className="text-2xl font-bold text-red-600">‚Çπ{calculations.netDebit.toLocaleString()}</p>
                      <p className="text-sm text-gray-600 mt-3 mb-1">Total Expenses</p>
                      <p className="text-xl font-bold text-orange-600">‚Çπ{calculations.totalDebit.toLocaleString()}</p>
                    </div>
                    <TrendingDown />
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-5">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600 mb-1">Current Balance</p>
                      <p className={`text-2xl font-bold ${calculations.currentBalance >= 0 ? "text-blue-600" : "text-red-600"}`}>
                        ‚Çπ{calculations.currentBalance.toLocaleString()}
                      </p>
                    </div>
                    <div className={`w-10 h-10 rounded-full ${calculations.currentBalance >= 0 ? "bg-blue-100" : "bg-red-100"} flex items-center justify-center`}>
                      <span className="text-2xl">{calculations.currentBalance >= 0 ? "üí∞" : "‚ö†Ô∏è"}</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Rest of sections (Meal, Breakdown, Summary) - already responsive */}
              <div className="bg-white rounded-lg shadow-lg p-5 mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Meal Expenses</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div className="border-l-4 border-orange-500 pl-4 py-2">
                    <p className="text-sm text-gray-600">Total Lunch</p>
                    <p className="text-2xl font-bold text-orange-600">‚Çπ{calculations.lunchTotal.toLocaleString()}</p>
                  </div>
                  <div className="border-l-4 border-purple-500 pl-4 py-2">
                    <p className="text-sm text-gray-600">Total Tea</p>
                    <p className="text-2xl font-bold text-purple-600">‚Çπ{calculations.teaTotal.toLocaleString()}</p>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-5 mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Expense Breakdown (Excluding Meals)</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  {Object.entries(calculations.expenseByDescription)
                    .sort(([,a],[,b]) => b - a)
                    .map(([desc, amt]) => (
                      <div key={desc} className="border-l-4 border-indigo-500 pl-4 py-2">
                        <p className="text-sm text-gray-600">{desc}</p>
                        <p className="text-lg font-bold text-gray-800">‚Çπ{amt.toLocaleString()}</p>
                      </div>
                    ))}
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-5">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Monthly Summary</h2>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                  <div className="border-l-4 border-blue-500 pl-4">
                    <p className="text-sm text-gray-600">Opening Balance (Salary)</p>
                    <p className="text-3xl font-bold text-blue-600">‚Çπ{calculations.openingBalance.toLocaleString()}</p>
                  </div>
                  <div className="border-l-4 border-green-500 pl-4">
                    <p className="text-sm text-gray-600">Other Credits (Income)</p>
                    <p className="text-3xl font-bold text-green-600">‚Çπ{calculations.totalCredit.toLocaleString()}</p>
                  </div>
                  <div className="border-l-4 border-red-500 pl-4">
                    <p className="text-sm text-gray-600">Total Debit (Expenses)</p>
                    <p className="text-3xl font-bold text-red-600">‚Çπ{calculations.totalDebit.toLocaleString()}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<MonthlyExpenseSheet />);
    </script>
  </body>
</html>