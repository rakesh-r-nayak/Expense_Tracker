<script type="text/babel">
  const firebaseConfig = {
    apiKey: "AIzaSyAoofQz9iOxLDl9Xa_f_UbzZCkshNCjUW4",
    authDomain: "expense-report-826a7.firebaseapp.com",
    projectId: "expense-report-826a7",
    storageBucket: "expense-report-826a7.firebasestorage.app",
    messagingSenderId: "238599367354",
    appId: "1:238599367354:web:dd12a7dc2c6e70aea0f083",
    measurementId: "G-QW3LYEC24T",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const { useState, useEffect, useMemo } = React;

  // Icons
  const Plus = () => (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
  );

  const Trash2 = () => (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <polyline points="3 6 5 6 21 6"></polyline>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      <line x1="10" y1="11" x2="10" y2="17"></line>
      <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
  );

  const Cloud = () => (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
    </svg>
  );

  const MonthlyExpenseSheet = () => {
    const [month, setMonth] = useState("January");
    const [year, setYear] = useState("2025");
    const [startingBalance, setStartingBalance] = useState(50000);
    const [expenses, setExpenses] = useState([]); // empty initial state
    const [syncStatus, setSyncStatus] = useState("synced");
    const [loading, setLoading] = useState(true); // loading flag
    const FIXED_USER_ID = "rakesh-expense-tracker";
    const [userId] = useState(FIXED_USER_ID);

    const expenseOptions = [
      "Ravi Fast Food",
      "E Trade",
      "Fuel",
      "Udayavani Canteen",
      "Hotel Manohar Bhavan",
      "Manipal Lunch Home",
      "Vinayak Store",
      "Darsh Fast Food",
      "Anand Bhavan",
      "Medical Store",
      "Other (Custom)",
    ];

    const mealOptions = ["", "Lunch", "Tea"];

    // Load data from cloud
    const loadFromCloud = async () => {
      if (!userId) return;
      try {
        const doc = await db.collection("expenseTracker").doc(userId).get();
        if (doc.exists) {
          const data = doc.data();
          setMonth(data.month || "January");
          setYear(data.year || "2025");
          setStartingBalance(data.startingBalance || 0);
          setExpenses(data.expenses || []);
        }
      } catch (error) {
        console.error("Firebase load error:", error);
      } finally {
        setLoading(false);
      }
    };

    useEffect(() => {
      loadFromCloud();
    }, [userId]);

    // Auto-sync to cloud
    useEffect(() => {
      if (!userId) return;
      const dataToSync = { month, year, startingBalance, expenses, userId, lastUpdated: new Date().toISOString() };
      const timeoutId = setTimeout(() => {
        setSyncStatus("syncing");
        db.collection("expenseTracker").doc(userId).set(dataToSync)
          .then(() => setSyncStatus("synced"))
          .catch(() => setSyncStatus("error"));
      }, 1000);
      return () => clearTimeout(timeoutId);
    }, [month, year, startingBalance, expenses, userId]);

    // Add new expense
    const addExpense = () => {
      const newId = Math.max(...expenses.map((e) => e.id), 0) + 1;
      setExpenses([...expenses, { id: newId, date: new Date().toISOString().split("T")[0], description: "", debit: "", credit: "", meal: "", isCustom: false }]);
    };

    // Delete single expense
    const deleteExpense = (id) => {
      const updatedExpenses = expenses.filter((e) => e.id !== id);
      setExpenses(updatedExpenses);
      if (userId) {
        db.collection("expenseTracker").doc(userId).set({ month, year, startingBalance, expenses: updatedExpenses, userId, lastUpdated: new Date().toISOString() });
      }
    };

    // Clear all expenses
    const clearAllExpenses = () => {
      if (!confirm("Are you sure you want to delete all expenses?")) return;
      setExpenses([]);
      if (userId) {
        db.collection("expenseTracker").doc(userId).set({ month, year, startingBalance, expenses: [], userId, lastUpdated: new Date().toISOString() });
      }
    };

    // Update expense
    const updateExpense = (id, field, value) => {
      setExpenses((prevExpenses) =>
        prevExpenses.map((e) => {
          if (e.id === id) {
            if (field === "debit") return { ...e, debit: value, credit: "" };
            if (field === "credit") return { ...e, credit: value, debit: "" };
            return { ...e, [field]: value };
          }
          return e;
        })
      );
    };

    // Calculations
    const calculations = useMemo(() => {
      const openingBalance = Number(startingBalance) || 0;
      const totalDebit = expenses.reduce((sum, e) => sum + (Number(e.debit) || 0), 0);
      const totalCredit = expenses.reduce((sum, e) => sum + (Number(e.credit) || 0), 0);
      let runningBalance = openingBalance;
      expenses.forEach((e) => { runningBalance += Number(e.credit || 0); runningBalance -= Number(e.debit || 0); });

      return {
        openingBalance,
        totalDebit,
        totalCredit,
        currentBalance: runningBalance,
        lunchTotal: expenses.filter(e => e.meal === "Lunch").reduce((sum, e) => sum + (Number(e.debit) || 0), 0),
        teaTotal: expenses.filter(e => e.meal === "Tea").reduce((sum, e) => sum + (Number(e.debit) || 0), 0),
        expenseByDescription: expenses.reduce((acc, e) => {
          if (e.description && !mealOptions.includes(e.meal)) acc[e.description] = (acc[e.description] || 0) + (Number(e.debit) || 0);
          return acc;
        }, {})
      };
    }, [expenses, startingBalance]);

    const getSyncStatusColor = () => {
      switch(syncStatus) {
        case "syncing": return "text-yellow-600";
        case "synced": return "text-green-600";
        case "error": return "text-red-600";
        default: return "text-gray-600";
      }
    };

    const getSyncStatusText = () => {
      switch(syncStatus) {
        case "syncing": return "Syncing...";
        case "synced": return "All changes saved";
        case "error": return "Sync error";
        default: return "Local storage";
      }
    };

    if (loading) return <p className="text-center text-gray-600">Loading...</p>;

    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h1 className="text-3xl font-bold text-gray-800">Monthly Expense Sheet</h1>
              <div className="flex items-center gap-3 flex-wrap">
                <div className={`flex items-center gap-2 ${getSyncStatusColor()}`}>
                  <Cloud />
                  <span className="text-sm">{getSyncStatusText()}</span>
                </div>
                <button onClick={addExpense} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"><Plus /> Add Row</button>
                <button onClick={clearAllExpenses} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Clear All</button>
              </div>
            </div>

            {calculations.currentBalance < 0 && (
              <div className="bg-red-100 text-red-800 px-4 py-2 rounded mb-4">
                ⚠️ Warning: Your expenses exceed your available balance!
              </div>
            )}

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-indigo-600 text-white">
                  <tr>
                    <th className="px-4 py-3 text-left font-semibold">Date</th>
                    <th className="px-4 py-3 text-left font-semibold">Description</th>
                    <th className="px-4 py-3 text-left font-semibold">Meal</th>
                    <th className="px-4 py-3 text-left font-semibold">Debit (₹)</th>
                    <th className="px-4 py-3 text-left font-semibold">Credit (₹)</th>
                    <th className="px-4 py-3 text-center font-semibold">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((expense) => (
                    <tr key={expense.id} className="bg-white">
                      <td className="px-4 py-3">
                        <input type="date" value={expense.date} onChange={(e) => updateExpense(expense.id, "date", e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded" />
                      </td>
                      <td className="px-4 py-3">
                        <input type="text" value={expense.description} onChange={(e) => updateExpense(expense.id, "description", e.target.value)} placeholder="Enter description" className="w-full px-2 py-1 border border-gray-300 rounded" />
                      </td>
                      <td className="px-4 py-3">
                        <select value={expense.meal} onChange={(e) => updateExpense(expense.id, "meal", e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded">
                          {mealOptions.map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                      </td>
                      <td className="px-4 py-3">
                        <input type="number" min="0" value={expense.debit} onChange={(e) => updateExpense(expense.id, "debit", e.target.value)} placeholder="0" className="w-full px-2 py-1 border border-gray-300 rounded" />
                      </td>
                      <td className="px-4 py-3">
                        <input type="number" min="0" value={expense.credit} onChange={(e) => updateExpense(expense.id, "credit", e.target.value)} placeholder="0" className="w-full px-2 py-1 border border-gray-300 rounded" />
                      </td>
                      <td className="px-4 py-3 text-center">
                        <button onClick={() => deleteExpense(expense.id)} className="text-red-600 hover:text-red-800"><Trash2 /></button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<MonthlyExpenseSheet />);
</script>
