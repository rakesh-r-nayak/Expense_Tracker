<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Expense Tracker</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const firebaseConfig = {
  apiKey: "AIzaSyAoofQz9iOxLDl9Xa_f_UbzZCkshNCjUW4",
  authDomain: "expense-report-826a7.firebaseapp.com",
  projectId: "expense-report-826a7",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const { useState, useMemo, useEffect } = React;

const MonthlyExpenseSheet = () => {
  const [month, setMonth] = useState("January");
  const [year, setYear] = useState("2025");
  const userId = "rakesh-expense-tracker";

  const [expenses, setExpenses] = useState([
    { id: 1, date: "2025-01-01", description: "Opening Balance (Salary)", debit: "", credit: "50000" }
  ]);

  /* ---------------- CALCULATIONS ---------------- */
  const calculations = useMemo(() => {
    const openingBalance = expenses
      .filter(e => e.description === "Opening Balance (Salary)")
      .reduce((s, e) => s + (parseFloat(e.credit) || 0), 0);

    const totalDebit = expenses
      .filter(e => e.description !== "Opening Balance (Salary)")
      .reduce((s, e) => s + (parseFloat(e.debit) || 0), 0);

    const totalCredit = expenses
      .filter(e => e.description !== "Opening Balance (Salary)")
      .reduce((s, e) => s + (parseFloat(e.credit) || 0), 0);

    const currentBalance = openingBalance + totalCredit - totalDebit;

    return { openingBalance, totalDebit, totalCredit, currentBalance };
  }, [expenses]);

  /* ---------------- ROW ACTIONS ---------------- */
  const addRow = () => {
    setExpenses([
      ...expenses,
      {
        id: Date.now(),
        date: new Date().toISOString().split("T")[0],
        description: "",
        debit: "",
        credit: ""
      }
    ]);
  };

  const updateRow = (id, field, value) => {
    setExpenses(expenses.map(e =>
      e.id === id ? { ...e, [field]: value } : e
    ));
  };

  const deleteRow = (id) => {
    setExpenses(expenses.filter(e => e.id !== id));
  };

  /* ---------------- EXCEL ---------------- */
  const exportToExcel = () => {
    const data = [
      ["Date", "Description", "Debit", "Credit"],
      ...expenses.map(e => [e.date, e.description, e.debit, e.credit])
    ];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Expenses");
    XLSX.writeFile(wb, `Expense_${month}_${year}.xlsx`);
  };

  const importFromExcel = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = evt => {
      const wb = XLSX.read(evt.target.result, { type: "array" });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
      setExpenses(
        rows.slice(1).map((r, i) => ({
          id: i + 1,
          date: r[0] || "",
          description: r[1] || "",
          debit: r[2] || "",
          credit: r[3] || ""
        }))
      );
    };
    reader.readAsArrayBuffer(file);
  };

  /* ---------------- FIREBASE SYNC ---------------- */
  useEffect(() => {
    db.collection("expenseTracker").doc(userId).set({
      month,
      year,
      expenses,
      lastUpdated: new Date().toISOString()
    });
  }, [month, year, expenses]);

  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-4">Monthly Expense Tracker</h1>

      <div className="flex gap-3 mb-4 flex-wrap">
        <button onClick={addRow} className="bg-indigo-600 text-white px-4 py-2 rounded">Add Row</button>
        <button onClick={exportToExcel} className="bg-green-600 text-white px-4 py-2 rounded">Export Excel</button>
        <label className="bg-blue-600 text-white px-4 py-2 rounded cursor-pointer">
          Import Excel
          <input type="file" className="hidden" onChange={importFromExcel} />
        </label>
      </div>

      <div className="overflow-x-auto bg-white rounded shadow mb-6">
        <table className="w-full">
          <thead className="bg-gray-200">
            <tr>
              <th className="p-2">Date</th>
              <th className="p-2">Description</th>
              <th className="p-2">Debit</th>
              <th className="p-2">Credit</th>
              <th className="p-2">Action</th>
            </tr>
          </thead>
          <tbody>
            {expenses.map(e => (
              <tr key={e.id} className="border-t">
                <td className="p-2">
                  <input type="date" value={e.date}
                    onChange={ev => updateRow(e.id, "date", ev.target.value)} />
                </td>
                <td className="p-2">
                  <input value={e.description}
                    onChange={ev => updateRow(e.id, "description", ev.target.value)} />
                </td>
                <td className="p-2">
                  <input type="number" value={e.debit}
                    disabled={e.description === "Opening Balance (Salary)"}
                    onChange={ev => updateRow(e.id, "debit", ev.target.value)} />
                </td>
                <td className="p-2">
                  <input type="number" value={e.credit}
                    onChange={ev => updateRow(e.id, "credit", ev.target.value)} />
                </td>
                <td className="p-2 text-center">
                  {e.description !== "Opening Balance (Salary)" && (
                    <button onClick={() => deleteRow(e.id)} className="text-red-600">Delete</button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-white p-4 rounded shadow">
          Opening Balance<br /><b>₹{calculations.openingBalance.toLocaleString()}</b>
        </div>
        <div className="bg-white p-4 rounded shadow">
          Other Credits<br /><b className="text-green-600">₹{calculations.totalCredit.toLocaleString()}</b>
        </div>
        <div className="bg-white p-4 rounded shadow">
          Total Debit<br /><b className="text-red-600">₹{calculations.totalDebit.toLocaleString()}</b>
        </div>
        <div className="bg-white p-4 rounded shadow">
          Current Balance<br /><b>₹{calculations.currentBalance.toLocaleString()}</b>
        </div>
      </div>
    </div>
  );
};

ReactDOM.render(<MonthlyExpenseSheet />, document.getElementById("root"));
</script>
</body>
</html>
