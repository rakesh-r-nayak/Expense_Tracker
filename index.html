<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Expense Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
      body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      input[type="number"] { -moz-appearance: textfield; }

      .table-container::after {
        content: '← Scroll horizontally →';
        display: block;
        text-align: center;
        padding: 8px;
        background: #eef2ff;
        color: #4f46e5;
        font-size: 0.875rem;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
      }
      @media (min-width: 768px) { .table-container::after { display: none; } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;

      const firebaseConfig = {
        apiKey: "AIzaSyAoofQz9iOxLDl9Xa_f_UbzZCkshNCjUW4",
        authDomain: "expense-report-826a7.firebaseapp.com",
        projectId: "expense-report-826a7",
        storageBucket: "expense-report-826a7.firebasestorage.app",
        messagingSenderId: "238599367354",
        appId: "1:238599367354:web:dd12a7dc2c6e70aea0f083",
        measurementId: "G-QW3LYEC24T",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Icons
      const Plus = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      );

      const Trash2 = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      );

      const Calendar = () => (
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      );

      const CreditCard = () => (
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
          <line x1="1" y1="10" x2="23" y2="10" />
        </svg>
      );

      const Cloud = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />
        </svg>
      );

      const App = () => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [activeTab, setActiveTab] = useState("monthly");

        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((u) => {
            setUser(u);
            setLoading(false);
          });
          return () => unsubscribe();
        }, []);

        const signIn = () => {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch((error) => {
            alert("Sign in error: " + error.message);
          });
        };

        const signOut = () => {
          auth.signOut();
        };

        if (loading) {
          return <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100"><p className="text-xl">Loading...</p></div>;
        }

        if (!user) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
              <div className="bg-white rounded-lg shadow-lg p-8 text-center max-w-md">
                <h1 className="text-3xl font-bold text-gray-800 mb-6">Secure Expense Tracker</h1>
                <p className="text-gray-600 mb-8">Sign in with Google to access your private data</p>
                <button onClick={signIn} className="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg flex items-center gap-3 mx-auto">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5c1.61 0 3.06.6 4.21 1.57l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84C6.71 7.31 9.14 5 12 5z" fill="#EA4335"/>
                  </svg>
                  Sign in with Google
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6">
            <div className="max-w-7xl mx-auto">
              <div className="flex flex-wrap items-center justify-between mb-6 gap-4 bg-white p-4 rounded-lg shadow">
                <div className="flex items-center gap-4">
                  <img src={user.photoURL || 'https://via.placeholder.com/40'} alt="Profile" className="w-10 h-10 rounded-full" />
                  <div>
                    <p className="text-sm text-gray-600">Signed in as</p>
                    <p className="font-medium">{user.displayName || user.email}</p>
                  </div>
                </div>
                <button onClick={signOut} className="text-red-600 hover:text-red-800 font-medium">
                  Sign out
                </button>
              </div>

              <div className="flex flex-wrap gap-2 mb-6">
                <button onClick={() => setActiveTab("monthly")} className={`flex items-center gap-3 px-6 py-3 rounded-lg font-semibold transition ${activeTab === "monthly" ? "bg-indigo-600 text-white shadow-lg" : "bg-white text-gray-700 shadow hover:bg-gray-100"}`}>
                  <Calendar /> Monthly Expenses
                </button>
                <button onClick={() => setActiveTab("credit")} className={`flex items-center gap-3 px-6 py-3 rounded-lg font-semibold transition ${activeTab === "credit" ? "bg-red-600 text-white shadow-lg" : "bg-white text-gray-700 shadow hover:bg-gray-100"}`}>
                  <CreditCard /> Credit Card Expenses
                </button>
              </div>

              {activeTab === "monthly" ? <MonthlyExpenseSheet userId={user.uid} /> : <CreditCardExpenseSheet userId={user.uid} />}
            </div>
          </div>
        );
      };

      // Full Monthly Expense Sheet (secure version)
      const MonthlyExpenseSheet = ({ userId }) => {
        const currentDate = new Date();
        const [month, setMonth] = useState(currentDate.toLocaleString('default', { month: 'long' }));
        const [year, setYear] = useState(currentDate.getFullYear().toString());
        const [startingBalance, setStartingBalance] = useState(50000);
        const [syncStatus, setSyncStatus] = useState("synced");
        const [expenses, setExpenses] = useState([]);
        const isInitialLoad = useRef(true);

        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const monthIndex = months.indexOf(month);
        const monthKey = `${year}-${String(monthIndex + 1).padStart(2, "0")}`;

        const expenseOptions = ["Ravi Fast Food","E Trade","Fuel","Udayavani Canteen","Hotel Manohar Bhavan","Manipal Lunch Home","Vinayak Store","Darsh Fast Food","Anand Bhavan","Medical Store","Other (Custom)"];
        const mealOptions = ["", "Lunch", "Tea"];

        const loadFromCloud = useCallback(async () => {
          try {
            const doc = await db.collection("expenseTracker").doc(userId).collection("months").doc(monthKey).get();
            if (doc.exists) {
              const data = doc.data();
              setStartingBalance(data.startingBalance ?? 50000);
              setExpenses(data.expenses ?? []);
            } else {
              setExpenses([]);
            }
          } catch (e) { console.error(e); }
        }, [userId, monthKey]);

        const syncToCloud = useCallback(async (data) => {
          if (isInitialLoad.current) return;
          try {
            setSyncStatus("syncing");
            await db.collection("expenseTracker").doc(userId).collection("months").doc(monthKey).set(data);
            setSyncStatus("synced");
          } catch (e) {
            console.error(e);
            setSyncStatus("error");
          }
        }, [userId, monthKey]);

        useEffect(() => { loadFromCloud(); }, [loadFromCloud]);

        useEffect(() => {
          if (isInitialLoad.current) { isInitialLoad.current = false; return; }
          const dataToSync = { month, year, startingBalance, expenses, lastUpdated: new Date().toISOString() };
          const timer = setTimeout(() => syncToCloud(dataToSync), 800);
          return () => clearTimeout(timer);
        }, [month, year, startingBalance, expenses, syncToCloud]);

        // ... (add the rest of your MonthlyExpenseSheet functions and JSX from the previous working version, replacing any FIXED_USER_ID with userId)

        // Example placeholder JSX (replace with your full one)
        return (
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h1 className="text-3xl font-bold">Monthly Expenses (Secure)</h1>
            <p>User ID: {userId}</p>
            {/* Paste your full table and summaries here */}
          </div>
        );
      };

      // Full Credit Card Expense Sheet (secure, simplified)
      const CreditCardExpenseSheet = ({ userId }) => {
        const currentDate = new Date();
        const [month, setMonth] = useState(currentDate.toLocaleString('default', { month: 'long' }));
        const [year, setYear] = useState(currentDate.getFullYear().toString());
        const [entries, setEntries] = useState([]);
        const [syncStatus, setSyncStatus] = useState("synced");
        const isInitialLoad = useRef(true);

        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const monthIndex = months.indexOf(month);
        const monthKey = `${year}-${String(monthIndex + 1).padStart(2, "0")}`;

        const mealOptions = ["", "Lunch", "Tea"];

        const loadFromCloud = useCallback(async () => {
          try {
            const doc = await db.collection("creditCardExpenses").doc(userId).collection("months").doc(monthKey).get();
            if (doc.exists) {
              setEntries(doc.data().entries || []);
            } else {
              setEntries([]);
            }
          } catch (e) { console.error(e); }
        }, [userId, monthKey]);

        const syncToCloud = useCallback(async (data) => {
          if (isInitialLoad.current) return;
          try {
            setSyncStatus("syncing");
            await db.collection("creditCardExpenses").doc(userId).collection("months").doc(monthKey).set(data);
            setSyncStatus("synced");
          } catch (e) {
            console.error(e);
            setSyncStatus("error");
          }
        }, [userId, monthKey]);

        useEffect(() => { loadFromCloud(); }, [loadFromCloud]);

        useEffect(() => {
          if (isInitialLoad.current) { isInitialLoad.current = false; return; }
          const timer = setTimeout(() => syncToCloud({ month, year, entries, lastUpdated: new Date().toISOString() }), 800);
          return () => clearTimeout(timer);
        }, [month, year, entries, syncToCloud]);

        // ... (add your full CreditCardExpenseSheet code here, using userId)

        return (
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h1 className="text-3xl font-bold">Credit Card Expenses (Secure)</h1>
            <p>User ID: {userId}</p>
            {/* Paste your full table and summaries here */}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>